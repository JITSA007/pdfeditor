<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPDF Pro - Advanced Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        window.addEventListener('load', () => {
            if(window.pdfjsLib) {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }
        });
    </script>
    
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/downloadjs@1.4.7/download.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { background-color: #f3f4f6; overflow: hidden; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        .pdf-page-container {
            position: relative;
            margin-bottom: 30px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            background: white;
        }

        /* Text Layer Styles */
        .text-layer {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden;
            line-height: 1.0;
            pointer-events: none;
        }
        
        .smart-edit-active .text-layer { pointer-events: auto; }

        .text-layer span {
            color: transparent;
            position: absolute;
            white-space: pre;
            cursor: pointer;
            transform-origin: 0% 0%;
        }

        .smart-edit-active .text-layer span:hover {
            background-color: rgba(37, 99, 235, 0.15);
            outline: 1px solid #2563eb;
        }

        .interaction-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 20;
            pointer-events: none; 
        }

        /* Added Elements */
        .added-element {
            position: absolute;
            pointer-events: auto;
            border: 1px dashed transparent;
            z-index: 30;
        }
        .added-element:hover { border-color: #3b82f6; cursor: move; }
        .added-element.selected { border-color: #2563eb; border-style: solid; box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2); }
        
        .added-text {
            background: transparent;
            border: none;
            outline: none;
            color: black;
            white-space: nowrap;
            padding: 0;
            margin: 0;
            line-height: 1.1;
        }

        /* Font Classes */
        .font-sans-pdf { font-family: Arial, Helvetica, sans-serif; }
        .font-serif-pdf { font-family: 'Times New Roman', Times, serif; }
        .font-mono-pdf { font-family: 'Courier New', Courier, monospace; }

        .added-whiteout { background-color: white; }
        .added-replace { background-color: white; display: flex; align-items: center; }

        .drawing-layer { position: absolute; top: 0; left: 0; z-index: 15; pointer-events: none; }
        .drawing-layer.active { pointer-events: auto; cursor: crosshair; }

        .page-controls {
            position: absolute; top: -40px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 4px 12px; border-radius: 20px;
            display: flex; gap: 12px; opacity: 0; transition: opacity 0.2s; z-index: 50;
        }
        .pdf-page-container:hover .page-controls { opacity: 1; }

        .tool-btn.active { background-color: #eff6ff; color: #2563eb; border-color: #bfdbfe; }

        .spinner {
            width: 40px; height: 40px; border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen flex flex-col font-sans text-gray-800">

    <header class="bg-white border-b border-gray-200 px-4 py-2 flex items-center justify-between shadow-sm z-40">
        <div class="flex items-center gap-2">
            <i class="ph-fill ph-file-pdf text-3xl text-blue-600"></i>
            <h1 class="font-bold text-gray-800 tracking-tight hidden sm:block">SmartPDF <span class="text-blue-600">Pro</span></h1>
        </div>

        <!-- Toolbar -->
        <div class="flex items-center gap-1 bg-gray-50 p-1 rounded-xl border border-gray-200" id="toolbar" style="display:none;">
            <button onclick="setTool('cursor')" id="btn-cursor" class="tool-btn active p-2 rounded-lg transition" title="Move Tool">
                <i class="ph ph-cursor text-lg"></i>
            </button>
            <button onclick="setTool('smart-edit')" id="btn-smart-edit" class="tool-btn p-2 rounded-lg transition text-blue-600" title="Smart Text Replacement">
                <i class="ph ph-magic-wand text-lg"></i>
            </button>
            <button onclick="setTool('text')" id="btn-text" class="tool-btn p-2 rounded-lg transition" title="Add New Text">
                <i class="ph ph-text-t text-lg"></i>
            </button>

            <!-- Font Selector (Visible when text selected) -->
            <div id="font-selector-container" class="hidden flex items-center gap-2 ml-2 pl-2 border-l border-gray-300">
                <select id="font-family-select" onchange="updateSelectedFont()" class="bg-white border border-gray-300 rounded text-sm p-1 outline-none">
                    <option value="Sans">Sans-Serif</option>
                    <option value="Serif">Serif (Times)</option>
                    <option value="Mono">Monospace</option>
                </select>
            </div>

            <div class="w-px h-6 bg-gray-300 mx-1"></div>
            
            <button onclick="setTool('whiteout')" id="btn-whiteout" class="tool-btn p-2 rounded-lg transition" title="Whiteout">
                <i class="ph ph-eraser text-lg"></i>
            </button>
            <button onclick="setTool('draw')" id="btn-draw" class="tool-btn p-2 rounded-lg transition" title="Sign / Draw">
                <i class="ph ph-pen-nib text-lg"></i>
            </button>
            <button onclick="triggerImageUpload()" class="tool-btn p-2 rounded-lg transition" title="Add Image">
                <i class="ph ph-image text-lg"></i>
            </button>
            <input type="file" id="image-upload" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
        </div>

        <div class="flex items-center gap-2">
            <div id="upload-section">
                <label class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium cursor-pointer transition flex items-center gap-2 text-sm shadow-sm">
                    <i class="ph ph-upload-simple"></i> Upload
                    <input type="file" id="file-upload" accept="application/pdf" class="hidden" onchange="handleUpload(event)">
                </label>
            </div>
            <button id="new-project-btn" onclick="location.reload()" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition text-sm">
                New
            </button>
            <button id="download-btn" onclick="savePDF()" class="hidden bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition flex items-center gap-2 text-sm shadow-sm">
                <i class="ph ph-download-simple"></i> Download
            </button>
        </div>
    </header>

    <main class="flex-1 overflow-auto bg-gray-100/50 relative p-8 flex justify-center" id="main-area">
        <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
            <div class="bg-white p-10 rounded-3xl shadow-xl max-w-md border border-gray-100">
                <div class="bg-blue-50 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="ph-duotone ph-file-pdf text-4xl text-blue-600"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">Professional PDF Editor</h2>
                <p class="text-gray-500 mb-8">Edit text, sign, and organize pages securely in your browser.</p>
                <label class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-xl font-bold cursor-pointer transition inline-flex items-center gap-2 shadow-lg hover:shadow-blue-500/30">
                    <i class="ph ph-file-plus text-xl"></i> Choose PDF
                    <input type="file" accept="application/pdf" class="hidden" onchange="handleUpload(event)">
                </label>
            </div>
        </div>
        <div id="pdf-container" class="hidden flex flex-col items-center w-full max-w-5xl pb-20"></div>
    </main>

    <div id="loading" class="hidden fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex flex-col items-center justify-center">
        <div class="spinner mb-4"></div>
        <p class="text-gray-600 font-medium animate-pulse" id="loading-text">Loading...</p>
    </div>

    <script>
        const State = {
            pdfDoc: null,
            pdfBytes: null,
            pages: [],
            activeTool: 'cursor',
            scale: 1.5,
            isDrawing: false,
            lastPos: { x: 0, y: 0 },
            selectedElement: null
        };

        const UI = {
            welcome: document.getElementById('welcome-screen'),
            container: document.getElementById('pdf-container'),
            toolbar: document.getElementById('toolbar'),
            uploadSection: document.getElementById('upload-section'),
            newProjectBtn: document.getElementById('new-project-btn'),
            downloadBtn: document.getElementById('download-btn'),
            loading: document.getElementById('loading'),
            loadingText: document.getElementById('loading-text'),
            fontSelector: document.getElementById('font-selector-container'),
            fontFamilySelect: document.getElementById('font-family-select')
        };

        function toggleLoading(show, text = "Processing...") {
            UI.loading.classList.toggle('hidden', !show);
            UI.loadingText.innerText = text;
        }

        async function handleUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            toggleLoading(true, "Opening Document...");
            try {
                State.pdfBytes = await file.arrayBuffer();
                State.pdfDoc = await PDFLib.PDFDocument.load(State.pdfBytes);
                await renderDocument();
                UI.welcome.classList.add('hidden');
                UI.container.classList.remove('hidden');
                UI.toolbar.style.display = 'flex';
                UI.uploadSection.classList.add('hidden');
                UI.newProjectBtn.classList.remove('hidden');
                UI.downloadBtn.classList.remove('hidden');
            } catch (err) {
                alert("Error: " + err.message);
            } finally {
                toggleLoading(false);
            }
        }

        async function renderDocument() {
            UI.container.innerHTML = '';
            State.pages = [];
            const pdf = await pdfjsLib.getDocument({ data: State.pdfBytes }).promise;

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: State.scale });
                const pageId = `page-${i}`;
                
                State.pages.push({
                    id: pageId, originalIndex: i - 1, rotation: 0,
                    width: viewport.width, height: viewport.height,
                    pdfWidth: page.getViewport({ scale: 1 }).width,
                    pdfHeight: page.getViewport({ scale: 1 }).height
                });

                const container = document.createElement('div');
                container.id = pageId;
                container.className = 'pdf-page-container';
                container.style.width = `${viewport.width}px`;
                container.style.height = `${viewport.height}px`;

                const canvas = document.createElement('canvas');
                canvas.className = 'pdf-canvas';
                canvas.width = viewport.width; canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                const textLayer = document.createElement('div');
                textLayer.className = 'text-layer';
                const textContent = await page.getTextContent();
                
                textContent.items.forEach(item => {
                    const tx = pdfjsLib.Util.transform(viewport.transform, item.transform);
                    const fontHeight = Math.sqrt((tx[2] * tx[2]) + (tx[3] * tx[3]));
                    const span = document.createElement('span');
                    span.textContent = item.str;
                    span.style.left = `${tx[4]}px`;
                    span.style.top = `${tx[5] - fontHeight}px`;
                    span.style.fontSize = `${fontHeight}px`;
                    
                    // GUESSED FONT TYPE
                    let fontType = 'Sans';
                    const name = (item.fontName || '').toLowerCase();
                    if (name.includes('times') || name.includes('serif')) fontType = 'Serif';
                    if (name.includes('courier') || name.includes('mono')) fontType = 'Mono';
                    span.dataset.fontType = fontType;

                    span.onclick = (e) => {
                        if (State.activeTool === 'smart-edit') {
                            e.stopPropagation();
                            initReplacement(span, container.querySelector('.interaction-layer'));
                        }
                    };
                    textLayer.appendChild(span);
                });

                const drawCanvas = document.createElement('canvas');
                drawCanvas.className = 'drawing-layer';
                drawCanvas.width = viewport.width; drawCanvas.height = viewport.height;
                initDrawingEvents(drawCanvas);

                const interactLayer = document.createElement('div');
                interactLayer.className = 'interaction-layer';
                interactLayer.onclick = (e) => {
                    if (State.activeTool === 'text') createTextElement(e, interactLayer);
                    if (State.activeTool === 'whiteout') createWhiteout(e, interactLayer);
                };

                container.append(canvas, textLayer, drawCanvas, interactLayer);
                UI.container.appendChild(container);
            }
        }

        function setTool(tool) {
            State.activeTool = tool;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${tool}`)?.classList.add('active');
            document.body.classList.toggle('smart-edit-active', tool === 'smart-edit');
            document.querySelectorAll('.drawing-layer').forEach(l => l.classList.toggle('active', tool === 'draw'));
            deselectAll();
        }

        function deselectAll() {
            document.querySelectorAll('.added-element').forEach(el => el.classList.remove('selected'));
            State.selectedElement = null;
            UI.fontSelector.classList.add('hidden');
        }

        function initReplacement(span, layer) {
            const rect = span.getBoundingClientRect();
            const lRect = layer.getBoundingClientRect();
            const x = rect.left - lRect.left;
            const y = rect.top - lRect.top;
            
            createReplaceBox(x, y, rect.width + 6, rect.height, span.textContent, span.dataset.fontType, layer);
            setTool('cursor');
        }

        function createReplaceBox(x, y, w, h, text, fontType, parent) {
            const el = document.createElement('div');
            el.className = `added-element added-replace font-${fontType.toLowerCase()}-pdf`;
            el.dataset.fontType = fontType;
            el.style.left = `${x}px`; el.style.top = `${y}px`;
            el.style.minWidth = `${w}px`; el.style.minHeight = `${h}px`;

            const input = document.createElement('div');
            input.contentEditable = true;
            input.className = 'added-text';
            input.innerText = text;
            input.style.fontSize = `${h * 0.9}px`;
            
            el.onclick = (e) => { e.stopPropagation(); selectElement(el); };
            el.appendChild(input);
            el.appendChild(createDelBtn(el));
            parent.appendChild(el);
            
            makeDraggable(el);
            selectElement(el);
            setTimeout(() => {
                input.focus();
                document.execCommand('selectAll', false, null);
            }, 10);
        }

        function selectElement(el) {
            deselectAll();
            State.selectedElement = el;
            el.classList.add('selected');
            if (el.dataset.fontType) {
                UI.fontSelector.classList.remove('hidden');
                UI.fontFamilySelect.value = el.dataset.fontType;
            }
        }

        function updateSelectedFont() {
            if (!State.selectedElement) return;
            const font = UI.fontFamilySelect.value;
            State.selectedElement.dataset.fontType = font;
            State.selectedElement.className = State.selectedElement.className.replace(/font-\w+-pdf/g, '');
            State.selectedElement.classList.add(`font-${font.toLowerCase()}-pdf`);
        }

        function createTextElement(e, parent) {
            const rect = parent.getBoundingClientRect();
            createReplaceBox(e.clientX - rect.left, e.clientY - rect.top, 100, 20, 'New Text', 'Sans', parent);
            setTool('cursor');
        }

        function createWhiteout(e, parent) {
            const rect = parent.getBoundingClientRect();
            const el = document.createElement('div');
            el.className = 'added-element added-whiteout';
            el.style.left = `${e.clientX - rect.left}px`;
            el.style.top = `${e.clientY - rect.top}px`;
            el.style.width = '80px'; el.style.height = '20px';
            el.style.resize = 'both'; el.style.overflow = 'hidden';
            el.appendChild(createDelBtn(el));
            parent.appendChild(el);
            makeDraggable(el);
            setTool('cursor');
        }

        function createDelBtn(parent) {
            const b = document.createElement('button');
            b.innerHTML = '&times;';
            b.className = 'absolute -top-3 -right-3 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition';
            parent.classList.add('group');
            b.onclick = (e) => { e.stopPropagation(); parent.remove(); deselectAll(); };
            return b;
        }

        function makeDraggable(el) {
            let drag = false, sx, sy, il, it;
            el.onmousedown = (e) => {
                if (State.activeTool !== 'cursor' || e.target.tagName === 'BUTTON') return;
                drag = true; sx = e.clientX; sy = e.clientY;
                il = el.offsetLeft; it = el.offsetTop;
            };
            window.onmousemove = (e) => {
                if (!drag) return;
                el.style.left = `${il + (e.clientX - sx)}px`;
                el.style.top = `${it + (e.clientY - sy)}px`;
            };
            window.onmouseup = () => drag = false;
        }

        function initDrawingEvents(canvas) {
            const ctx = canvas.getContext('2d');
            ctx.lineCap = 'round'; ctx.strokeStyle = '#2563eb'; ctx.lineWidth = 2;
            canvas.onmousedown = (e) => {
                if (State.activeTool !== 'draw') return;
                State.isDrawing = true;
                const r = canvas.getBoundingClientRect();
                State.lastPos = { x: e.clientX - r.left, y: e.clientY - r.top };
            };
            canvas.onmousemove = (e) => {
                if (!State.isDrawing) return;
                const r = canvas.getBoundingClientRect();
                const x = e.clientX - r.left, y = e.clientY - r.top;
                ctx.beginPath(); ctx.moveTo(State.lastPos.x, State.lastPos.y);
                ctx.lineTo(x, y); ctx.stroke();
                State.lastPos = { x, y };
            };
            window.onmouseup = () => State.isDrawing = false;
        }

        function triggerImageUpload() { document.getElementById('image-upload').click(); }
        function handleImageUpload(e) {
            const file = e.target.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = (ev) => {
                const img = new Image(); img.src = ev.target.result;
                img.onload = () => {
                    const layer = document.querySelector('.interaction-layer');
                    const el = document.createElement('div');
                    el.className = 'added-element'; el.style.left = '50px'; el.style.top = '50px';
                    img.style.width = '150px'; img.className = 'pointer-events-none';
                    const h = document.createElement('div');
                    h.className = 'absolute bottom-0 right-0 w-3 h-3 bg-blue-500 cursor-nwse-resize';
                    h.onmousedown = (me) => {
                        me.stopPropagation();
                        const startW = img.offsetWidth, startX = me.clientX;
                        window.onmousemove = (we) => img.style.width = `${startW + (we.clientX - startX)}px`;
                        window.onmouseup = () => window.onmousemove = null;
                    };
                    el.append(img, h, createDelBtn(el)); layer.appendChild(el);
                    makeDraggable(el); setTool('cursor');
                };
            };
            reader.readAsDataURL(file);
        }

        async function savePDF() {
            toggleLoading(true, "Encoding Fonts & Elements...");
            try {
                const outPdf = await PDFLib.PDFDocument.create();
                const fonts = {
                    Sans: await outPdf.embedFont(PDFLib.StandardFonts.Helvetica),
                    Serif: await outPdf.embedFont(PDFLib.StandardFonts.TimesRoman),
                    Mono: await outPdf.embedFont(PDFLib.StandardFonts.Courier)
                };

                const containers = document.querySelectorAll('.pdf-page-container');
                for (let container of containers) {
                    const data = State.pages.find(p => p.id === container.id);
                    const [page] = await outPdf.copyPages(State.pdfDoc, [data.originalIndex]);
                    const newPage = outPdf.addPage(page);
                    const { width, height } = newPage.getSize();
                    const sX = width / data.width, sY = height / data.height;

                    // Drawings
                    const dCanvas = container.querySelector('.drawing-layer');
                    const dData = dCanvas.toDataURL('image/png');
                    if (dData.length > 500) {
                        const img = await outPdf.embedPng(dData);
                        newPage.drawImage(img, { x:0, y:0, width, height });
                    }

                    // Elements
                    container.querySelectorAll('.added-element').forEach(async el => {
                        const x = el.offsetLeft * sX, w = el.offsetWidth * sX, h = el.offsetHeight * sY;
                        const y = height - (el.offsetTop * sY) - h;

                        if (el.classList.contains('added-whiteout') || el.classList.contains('added-replace')) {
                            newPage.drawRectangle({ x, y, width: w, height: h, color: PDFLib.rgb(1, 1, 1) });
                        }

                        const text = el.querySelector('.added-text');
                        if (text && text.innerText.trim()) {
                            const fontType = el.dataset.fontType || 'Sans';
                            const fSize = (parseFloat(text.style.fontSize) || 16) * (width / data.pdfWidth);
                            newPage.drawText(text.innerText, {
                                x: x + (2 * sX), y: y + (h/2) - (fSize/3),
                                size: fSize, font: fonts[fontType], color: PDFLib.rgb(0, 0, 0)
                            });
                        }
                        
                        const img = el.querySelector('img');
                        if (img) {
                            const bytes = await fetch(img.src).then(r => r.arrayBuffer());
                            const embed = await outPdf.embedPng(bytes);
                            newPage.drawImage(embed, { x, y, width: w, height: h });
                        }
                    });
                }
                const bytes = await outPdf.save();
                download(bytes, "edited_pro.pdf", "application/pdf");
            } catch (e) { alert(e.message); } finally { toggleLoading(false); }
        }
    </script>
</body>
</html>
